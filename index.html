<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script>
    // GitHub Pages hardening: ensure trailing slash for directory URLs.
    // Prevents broken relative assets when opening .../<repo> (without ending "/").
    (function(){
      try{
        var p = location.pathname || "";
        var last = p.split("/").filter(Boolean).pop() || "";
        var looksLikeFile = last.indexOf(".") !== -1;
        if (!p.endsWith("/") && !looksLikeFile){
          location.replace(p + "/" + location.search + location.hash);
        }
      }catch(e){}
    })();
  </script>
  <title>Karusselli 4 KÜ — v1.86</title>
  <style>

    :root{
      /* Palette D — Warm Light (v1.86) */
      --bg0:#FAFAF9;
      --bg1:#F5F5F4;
      --bg2:#F5F5F4;

      --card:#FFFFFF;
      --stroke:#E7E5E4;

      --text:#1C1917;
      --muted:#57534E;

      --good:#16A34A;
      --warn:#CA8A04;

      --shadow: 0 4px 16px rgba(0,0,0,.06);
      --radius:14px;

      --pill:rgba(0,0,0,.03);
      --pill2:rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(37,99,235,.025), transparent 70%),
        radial-gradient(900px 500px at 80% 10%, rgba(37,99,235,.02), transparent 70%),

        linear-gradient(180deg, var(--bg0), var(--bg2));
      overflow-x:hidden;
    }
    body:before{
      content:"";
      position:fixed; inset:0;
      background-image: radial-gradient(rgba(0,0,0,.06) 1px, transparent 1px);
      background-size: 26px 26px;
      opacity:.10;
      pointer-events:none;
      mask-image: radial-gradient(900px 600px at 50% 30%, black 45%, transparent 70%);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(250,250,249,.78));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
    }
    .topbar-inner{
      max-width:1020px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
    }
    .brand h1{margin:0; font-size:18px; font-weight:900; letter-spacing:.2px}
    .brand small{display:block; margin-top:4px; color:var(--muted); font-size:12px}

    .right-actions{display:flex; gap:10px; align-items:center; justify-content:flex-end}
    .status{
      display:flex; align-items:center; gap:10px;
      padding:8px 12px;
      border-radius:999px;
      background:var(--pill);
      color:var(--muted);
      border:1px solid var(--stroke);
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good); box-shadow:0 0 0 3px rgba(53,208,127,.16)}
    .dot.bad{background:#ff4d4d; box-shadow:0 0 0 3px rgba(255,77,77,.14)}
    .btn{
      border:1px solid var(--stroke);
      background:var(--pill);
      color:var(--muted);
      color:var(--text);
      padding:8px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn:hover{background:var(--pill2)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(107,124,255,.95), rgba(79,101,255,.85));
      border-color: rgba(107,124,255,.35);
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.active{
      background: rgba(107,124,255,.22);
      border-color: rgba(107,124,255,.38);
    }

    .wrap{max-width:1020px; margin:0 auto; padding:18px 16px 28px}

    .auth-grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
    @media (max-width:900px){ .auth-grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card-pad{padding:16px}
    .card h2{margin:0 0 8px; font-size:16px; font-weight:900}
    .sub{margin:0 0 10px; color:var(--muted); font-size:12px}
    label{display:block; color:var(--muted); font-size:12px; margin-top:10px}
    input{
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid rgba(107,124,255,.55);
  background:#eef4ff;
  box-shadow:0 0 0 4px rgba(107,124,255,.16);
  outline:none;
  transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
}
    input:focus{
  border-color: rgba(107,124,255,.9);
  box-shadow:0 0 0 5px rgba(107,124,255,.22);
  background:#eef4ff;
}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .msg{margin-top:10px; font-size:13px}
    .msg.ok{color:var(--good)}
    .msg.err{color:#ff4d4d}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .hidden{display:none !important}

    
/* === AUTH INPUTS (v1.86 UI fix) === */
#authSection input,
#authSection textarea{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(107,124,255,.55);
  background:transparent;
  box-shadow:none;
  outline:none;
}
#authSection input:focus,
#authSection textarea:focus\{
  border-color: rgba\(107,124,255,.9\);
  box-shadow:none;
  background:transparent;
  outline:none;
\}

/* field widths — match mock (inputs are not full width) */
#authSection .auth-stack > div,
#authSection .register-grid .row > div{
  display:flex;
  flex-direction:column;
  align-items:flex-start;
}

/* default auth input width */
#authSection input,
#authSection textarea{
  width:min(100%, 280px);
}

/* narrower fields where needed */
#authSection #reg_pass{ width:min(100%, 220px); }
#authSection #reg_apt{ width:min(100%, 220px); }

/* button sizing/placement similar to mock */
#authSection .login-actions .btn.primary{ padding:8px 16px; border-radius:12px; }
#authSection .register-grid .actions .btn.primary{ padding:8px 16px; border-radius:12px; }

/* ensure rows don't stretch columns to full card width */
#authSection .register-grid .row{
  grid-template-columns: max-content max-content;
  justify-content:flex-start;
  column-gap:24px;
}
@media (max-width:520px){
  #authSection .register-grid .row{ grid-template-columns:1fr; }
  #authSection input, #authSection textarea{ width:100%; max-width: 320px; }
}


/* forgot link position — keep inline with button like mock */
#authSection .login-actions{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:16px;
  margin-top:12px;
  flex-wrap:nowrap;
}
#authSection .login-actions .muted{
  margin:0 !important;
  display:flex;
  align-items:center;
  line-height:1;
}
#authSection .login-actions a{ display:inline-block; padding:0; margin:0; }
@media (max-width:520px){
  #authSection .login-actions{ flex-wrap:wrap; }
}


/* === v1.86 precise auth sizing (per screenshot) === */

/* Narrow LEFT login card */
#authSection > .card:first-child{
  max-width: 420px;
}

/* Inputs even narrower */

/* Password + apartment slightly narrower */

/* Keep alignment clean */
#authSection .auth-stack > div,
#authSection .register-grid .row > div{
  align-items:flex-start;
}

/* On small screens allow full width */
@media (max-width:520px){
  #authSection > .card:first-child{
    max-width:100%;
  }
  #authSection input,
  #authSection textarea{
    width:100%;
    max-width:320px;
  }
}


/* === v1.86 align widths to bottom field (per arrows) === */

/* Reference width = apartment field */
#authSection #reg_apt{
  width: 210px;
}

/* Align indicated fields to the same width */
#authSection #log_user,
#authSection #log_pass,
#authSection #reg_user,
#authSection #reg_pass,
#authSection #reg_email{
  width: 210px;
}

/* Keep buttons unchanged */


/* === v1.86 HOME: Quick status layout (counts, no amounts) === */
#page_home .qs85-hidden{display:none !important;}

#page_home .qs85-wrap{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-top:8px;
}

#page_home .qs85-section{
  display:grid;
  grid-template-columns: 56px 1fr;
  gap:14px;
  align-items:center;
}

#page_home .qs85-icon{
  width:56px;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
}
#page_home .qs85-icon svg{width:56px;height:56px; display:block}

/* user icon PNGs */
#page_home .qs85-img{
  max-width:56px;
  max-height:56px;
  width:auto;
  height:auto;
  display:block;
}

#page_home .qs85-line{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  flex-wrap:wrap;
}

#page_home .qs85-title{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

#page_home .qs85-cards{
  display:flex;
  gap:12px;
  align-items:stretch;
}

#page_home .qs85-card{
  min-width:120px;
  padding:10px 12px;
  border:1px solid rgba(0,0,0,.10);
  border-radius:12px;
  background: rgba(255,255,255,.6);
}

#page_home .qs85-num{
  font-weight:900;
  font-size:18px;
  line-height:1;
}

#page_home .qs85-num.ok{ color: rgba(34,197,94,.95); }  /* green */
#page_home .qs85-num.bad{ color: rgba(239,68,68,.95); } /* red */

#page_home .qs85-lbl{
  font-size:12px;
  color:var(--text);
  margin-top:6px;
}

@media (max-width:720px){
  #page_home .qs85-section{grid-template-columns:1fr;}
  #page_home .qs85-icon{display:none;}
}

/* APP */
    .app-shell{display:grid; grid-template-columns: 1fr; gap:16px}
    .main{padding:14px; background: var(--card)}
    .tabs{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-bottom:12px}
    .tab{
      border:1px solid var(--stroke);
      background: var(--pill);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{background: rgba(37,99,235,.14); border-color: rgba(37,99,235,.25)}

    .page-title{margin:0 0 10px; font-weight:900; font-size:14px; color:var(--text)}
    .hero{
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(37,99,235,.06), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.35));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      min-height:340px;
      position:relative;
      overflow:hidden;
    }
    .hero .caption{
      position:absolute; left:0; right:0; bottom:12px;
      text-align:center;
      color:rgba(233,238,252,.9);
      font-weight:800;
      font-size:12px;
      letter-spacing:.2px;
      text-shadow: 0 8px 20px rgba(0,0,0,.12);
    }
    .hero:after{
      content:"";
      position:absolute;
      width:160px;height:160px;
      right:48px; top:30px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.20), rgba(255,255,255,.04) 55%, transparent 70%);
      border:1px solid rgba(255,255,255,.10);
      opacity:.45;
    }
    .house-svg{width:100%; height:100%; display:block; opacity:.55}
    .house-wrap{
      position:absolute;
      left:50%;
      top:52%;
      transform:translate(-50%,-50%);
      width:min(820px, 96%);
      height:290px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.55);
    }
    .house-wrap img{display:block;width:100%;height:100%;object-fit:cover;}

    .bottom-grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:14px}
    @media (max-width:900px){ .bottom-grid{grid-template-columns:1fr} }
    .mini{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:14px;
      min-height:150px;
    }
    .mini h4{margin:0 0 8px; font-size:13px; font-weight:900}
    .mini .muted{color:var(--muted); font-size:12px; line-height:1.45}
    ul{margin:10px 0 0 16px; color:var(--muted); font-size:12px; line-height:1.6}
    .status-cards{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px}
    .stat{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.015);
      border-radius:14px;
      padding:10px;
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
    }
    .stat .num{font-size:18px; font-weight:1000; color:var(--text); line-height:1}
    .stat .lbl{font-size:11px; color:var(--muted); margin-top:3px}

    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    th{font-size:12px; color:var(--muted); text-align:left; font-weight:800; padding:0 10px}
    td{
      background: rgba(0,0,0,.015);
      border:1px solid var(--stroke);
      padding:10px;
      font-size:13px;
    }
    td:first-child{border-radius:12px 0 0 12px}
    td:last-child{border-radius:0 12px 12px 0}
    .ok{color:var(--good); font-weight:900}
    .warn{color:var(--warn); font-weight:900}
  
    .modal{position:fixed; inset:0; z-index:2000}
    .modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,.35)}
    .modal-card{position:relative; width:min(720px, 92vw); margin:8vh auto 0; background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow: var(--shadow); overflow:hidden}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:14px 14px 10px; border-bottom:1px solid var(--stroke)}
    .modal-body{padding:14px}
    .iconbtn{border:1px solid var(--stroke); background:var(--pill); border-radius:10px; padding:8px 10px; cursor:pointer}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}

textarea{
  width:100%;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid rgba(107,124,255,.55);
  background:#eef4ff;
  box-shadow:0 0 0 4px rgba(107,124,255,.16);
  outline:none;
  transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
}
textarea:focus{
  border-color: rgba(107,124,255,.9);
  box-shadow:0 0 0 5px rgba(107,124,255,.22);
  background:#eef4ff;
}


    /* ====== v1.86 menu layout ====== */
    .langSelect{
      appearance: none;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .app-header{
      display:flex;
      justify-content:center;
      padding: 6px 0 10px;
    }
    .app-title{
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    .app-navrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 0 14px;
      border-top: 1px solid rgba(0,0,0,.06);
      border-bottom: 1px solid rgba(0,0,0,.06);
      margin-bottom: 12px;
    }
    .tabs-left{ margin: 0; }
    .nav-right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

  
/* === v1.86 quick status icon sizing === */
#page_home .qs85-icon img.qs-water {
  transform: scale(1.2);
  transform-origin: center;
}
#page_home .qs85-icon img.qs-pay {
  width: 56px;
  height: 56px;
}

</style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <h1 id="brandTitle">Karusselli 4 KÜ</h1><span id="versionBadge" style="margin-left:10px;font-size:12px;opacity:.75;white-space:nowrap">v1.86</span>
        <small id="brandSub"></small>
      </div>

      <div class="right-actions" id="topRightActions">
        <select id="langSelect" class="langSelect" aria-label="Language">
          <option value="ru">RU</option>
          <option value="et">EST</option>
          <option value="en">EN</option>
        </select>

        <div class="status" id="statusPill">
          <span id="statusDot" class="dot bad"></span>
          <span id="statusText">Вход не выполнен</span>
        </div>

        <button class="btn" id="btnTopLogout" style="display:none">Выйти</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- AUTH -->
    <section id="authSection" class="auth-grid">
      <div class="card card-pad">
        <h2 id="loginTitle">Войти</h2>
        <p class="sub" id="loginSub">Введите имя пользователя и пароль.</p>

        
<div class="auth-stack">
  <div>
    <label id="loginUserLabel">Имя пользователя</label>
    <input id="log_user" placeholder="например: member12" autocomplete="username"/>
  </div>
  <div>
    <label id="loginPassLabel">Пароль</label>
    <input id="log_pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
  </div>
</div>

<div class="login-actions">
  <button class="btn primary" id="btnLogin">Войти</button>
  <div class="muted">
    <a href="#" id="forgotLink" style="text-decoration:none" data-i18n="forgot">Forgot password?</a>
  </div>
</div>

<div id="log_msg" class="msg"></div>
      </div>

      <div class="card card-pad">
        <h2 id="registerTitle">Создать аккаунт</h2>
        <p class="sub" id="registerSub">Создайте имя пользователя и пароль.</p>

        
<div class="register-grid">
  <div class="row">
    <div>
      <label id="regUserLabel">Имя пользователя</label>
      <input id="reg_user" placeholder="например: test1" autocomplete="username"/>
    </div>
    <div>
      <label id="regPassLabel">Пароль</label>
      <input id="reg_pass" type="password" placeholder="минимум 6 символов" autocomplete="new-password"/>
    </div>
  </div>

  <div class="row">
    <div>
      <label id="regEmailLabel">Username or email</label>
      <input id="reg_email" type="email" placeholder="name@example.com" autocomplete="email"/>
    </div>
    <div></div>
  </div>

  <div class="row">
    <div>
      <label id="aptLabel">Квартира</label>
      <input id="reg_apt" placeholder="например: 5" inputmode="numeric"/>
    </div>
    <div></div>
  </div>

  <div class="actions">
    <button class="btn primary" id="btnRegister">Создать аккаунт</button>
  </div>

  <div id="reg_msg" class="msg"></div>
</div>

      </div>
    </section>

    <!-- APP -->
    <section id="appSection" class="app-shell hidden">
      <section class="card main">
        
        <div class="app-header">
          <div class="app-title" id="appPortalTitle">Karusselli 4 KÜ портал</div>
        </div>

        <div class="app-navrow">
          <div class="tabs tabs-left">
            <button class="tab active" id="tab_home" data-page="home">Главная</button>
          <button class="tab" id="tab_readings" data-page="readings">Показания</button>
          <button class="tab" id="tab_bills" data-page="bills">Счета</button>
          </div>
          <div class="nav-right" id="appRightControls"></div>
        </div>

<!-- HOME -->
        <div id="page_home">
          <div class="page-title" id="homeTitle">Главная</div>

          <div class="hero">
            
<div class="house-wrap">
  <img src="assets/images/197c2921-703f-422f-835d-02840e15c0ca.png"
       alt="Karusselli 4"
       style="width:100%;height:100%;object-fit:cover;border-radius:14px;"/>
</div>
            <div class="caption" id="heroCaption">Karusselli 4</div>
          </div>

          <div class="bottom-grid">
            <div class="mini">
              <h4 id="contactTitle">Контактная информация</h4>
              <div class="muted"><b id="boardMembersTitle">Члены правления</b></div>
              <ul>
                <li><span id="chairmanTitle">Председатель</span>: <span id="phName1">[имя фамилия]</span> — <span id="phEmailPhone1">[email]/телефон</span></li>
                <li><span id="boardMemberTitle">Член правления</span>: <span id="phName2">[имя фамилия]</span> — <span id="phEmailPhone2">[email]/телефон</span></li>
              </ul>
              <div class="muted" style="margin-top:10px"><b id="addressTitle">Адрес</b><br/><span id="addrLine">Karusselli 4, [город], Estonia</span></div>
              <div class="muted" style="margin-top:10px"><b id="bankDetailsTitle">Банковские реквизиты</b><br/>
                IBAN: <span id="phIban">[EE.. ..]</span><br/>
                <span id="bankTitle">Банк</span>: <span id="phBank">[Swedbank / SEB / ..]</span><br/>
                <span id="recipientTitle">Получатель</span>: Karusselli 4 KÜ
              </div>
            </div>

            <div class="mini">
              <h4 id="quickTitle">Быстрый статус</h4>

<!-- keep legacy nodes for existing JS/i18n, but hide visually -->
<div class="qs85-hidden">
  <div class="muted" id="quickSub">Сводка по прошлому месяцу (демо-данные):</div>

  <div class="status-cards">
    <div class="stat">
      <div class="num" id="stat_total">24</div>
      <div class="lbl" id="lbl_total">квартир всего</div>
    </div>
    <div class="stat">
      <div class="num" id="stat_done">20</div>
      <div class="lbl" id="lbl_done">сдали показания</div>
    </div>
    <div class="stat" style="grid-column:1 / span 2">
      <div class="num" id="stat_missing">4</div>
      <div class="lbl" id="lbl_missing">не сдали</div>
    </div>
  </div>

  <div class="muted" style="margin-top:10px" id="quickNote">
    Дальше подключим реальные данные: статусы можно показывать жильцу только по его квартире.
  </div>
</div>

<!-- v1.86 visible layout -->
<div class="qs85-wrap" id="quickStatus85">
  <div class="qs85-section">
    <div class="qs85-icon" aria-hidden="true">
      <img class="qs85-img" alt="" src="data:image/png;base64,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"/>
    </div>
    <div>
      <div class="qs85-title" id="qs85_curr_title">Сводка по текущему месяцу</div>
      <div class="qs85-cards">
        <div class="qs85-card">
          <div class="qs85-num ok" id="qs85_read_ok">4</div>
          <div class="qs85-lbl" id="qs85_read_ok_lbl">сдали показания</div>
        </div>
        <div class="qs85-card">
          <div class="qs85-num bad" id="qs85_read_bad">1</div>
          <div class="qs85-lbl" id="qs85_read_bad_lbl">не сдали</div>
        </div>
      </div>
    </div>
  </div>

  <div class="qs85-section">
    <div class="qs85-icon" aria-hidden="true">
      <img class="qs85-img" alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIwAAABGCAYAAAAes3zsAAAOAklEQVR4nO2ceZgU5Z3HP29VH9M9PT0zMMIwDDDcl7jAI4c+oLC6y65GF88oiMTFE3TXxKgJhGg26LOiJoj4rMFjo2TjQYI3Bs0SNAoSFSMicsglcjMX3dNnVb37R/UcQM9MV1802fo8zzxPV3XN+75V9a3f9b5dQkopsbFJEeVUD8Dm9MIWjI0lbMHYWMIWjI0lbMHYWMIWjI0lbMHYWMIWjI0lbMHYWMIWjI0lbMHYWMIWjI0lbMHYWMIWjI0lbMHYWMIWjI0lHKei0zU7dF78NEogAkKk10avLgq3neuid7mt+XySd8F8sFVn8pAGfvtpCTVdFHTDehuKgP/9WqPPoiANPy6htChN1dlYJu+C+eOWOE+8U8y1o10ZtTO+xsFXh3U+2q0zZcgpMZT/L8m7Pddc0LUi9W51CS9/FmNfw/GmSBFQU6rSFLOXJOeTvAtGSLCy7Hzh2xG++0AINclIDQm2M8ovBW3LF66KMPfBELtXlFHpt4PbQiDvd0FVIJmBqW2SrN+ttWwvWBnh3oUR9r1RRp9utlgKBUsWRgK7jupsOmAQiFpPiXUJP1sd5+Vp7qRtj18S5MmpHo41SeYvivDNy36q7LS5oEhZMKG45L5lER7ZE+ffRjjxewVSQl1EIqUEReBWwOdMriIBxA1gXQxletFJ31cUCz77YQmjfhIARbD/ZT89ymyxFBopC+anj0fYtFWndlEJXTytovjygMH+oIHPKRheqeDvpCbicULcSB71jqxU2fOwn2I3dPV2LhaF5O4tm4Tj8OE2+MvX0BjKcWdt8LlhdD84f6j5+ZSzchWQomDW7tF5Iayz+ZfFlCbEsnW3zh1vRnj3pShc64TNOjQI/uvGIm6d1P4ZajFJONj+bU61cislHAobuNXcxe11TTDveXhyMbAFGANogJ6zLs2noAj4CBgMV1wPi2dDVVkO+7RASld7w3aNG0eolHpNsXxTazCkbyPTH3fS9Gcfa/bqnHeLixXfSGb2C2CshtmTk4tmbKXKpeOCDP5apUe5Qlevgj/hoaIafJuotygJ3SRLwRUB7+3RePbjOA/808nuLRvoBjz9Fjw5GwbMhsX/A4Oq2g/as4mUsOsQLFgOv58HPcrgkZvBXQA5rR0k2FgiJc0eC0rKXa3a+sX7UVjs4Jk5bv6wQ2fqgAjXLXXwxHVu3tldwj/eHeKikU5qkriXi8Y6efb9Yh5aE+X1TRozz3Ty61leIrrkymdCvLVf57JeKq+sjoMLaDyhAQmowEHJqmUlOavPHKqHe5dD2Y2wch4MrMpJN+3SrzsM7QlTI7DkVbj1OzC8d37HkIyUBCMVWmxRTJM89kmMtXPcHKgzWLxcY8J8hd98KLn7EoNhfvCf5+Dj3XpSwagIbpjoZuYEN41hSZefBZhbazB/eQiigtBP/LidcEdTiIG9JNMudlDXCKpqmmqvC/YGYNrvYpxdqWbzWhxHKAyshuk/z79YmqnqCleNhY8fgYZjp2YMJ2LZKwZjwB7o6RMEmiQzznNww5oY9Ae/WxDVJeO90BjqeBpaEVDuFcw518ng6Q38y/kufn93cYufdjghFJM0BiQNwUTNR0LUBU0hSTuJVtbQDaAL+F2wLw5NecyQmvEWQZEL6AW61unhecGyYLp4BZPGq/xxv+SSKnjtCw3fBgg2GjTeJDnDI3hnj8EPzk3t6Z860EHTJW4W3eBNGtQJYdZwEnppIdeBpyoAL7y3BWKfQ109+Z24klDqh61bgMbCCTbTiruvGOpk1twQ9ct9LJwhGPRamF8tKGJwhcKidRocE4yvSU0wFw5zcsEwZ9J7IaX5pBuyteZiWJy8TJcjjcA2qJkK40phbx24nLnvtxldhx7lEPYA7tNcMLPOd7H61RjlVwZZ87CHdS95KYsZzHojxm8vj/HhVr+lRU3tHVlWIqjwC1RkSwzjcYLmUHDkIL2VBqx4x/x85RJgFChR6B6GoAbuPK6kiOpQGQZvDFBAKZBVHGkJxuMQLHu0hEUfRJn0UAwGGLAfLqp2suFgKaO6Zx6MOn2C2x9r4rmdRXzRJHEK07r0dAq2HdTBY4omW2zYBDc9ABteTOyohjGjQNWgSof6OHiy112nxDXoroNPAyKnuWCkBFWRzPt7N7ec4yTQZGYx1eUKQpLWoiZVCIramHzdBVdf7eP6cQ6iSQK+yjJBiTvzoKK2Hp5ZBouehQOfw/0Pm/svnAATzoHRd4J6GPoaQCzj7lJHguMwyIC5eVoLpjEimf1KGBVBQJPUxiRuBaqKFOJSols8uagG46oV7plchCNhnDQnXDXWwcVn5SZwCIfhw7Vwx72w5VP4zuUwbymMH2t+v2sXVA+CMSOg7xTTXeUbocBYDXgwP3FbKqQlmGKX4J7z3JaF0R5Sgt8jWqYD2u5PF12HujoIBo6/2UJAIADPPwePLoKzh8GzT8G110FRm1kGAYS2gSNhxMQpijodAryYKxULgbQE41RhZHXuimaZIiWs/wAWzoXNa83CcLNXK+4OwUMQB26+Dr7/IxgyvPX//vqx+fnIYehfA0f2wsZPIRq1NgahgBaHqmro3Tf9c1EkdOM0d0mFTt1RWDIfDq6FeU+Azw9GwsoIAfEYrFsFh3cfXxDTdZg+zvysAn1Hw5v/DU/dZ16oVLySSuuxJTVw0w/he3PSPxdFgp/CWbv8NymYcBD2/BluWwQzZyc/pl9/mD0ZDu+F4X9n7lNV+FUirc7EHQoB326DpbeDL8PUSsHMzk5rC1MflsxfGUHL4JeLbdF1OKu3wq0T3VlJlaUBJYDP2/4xXg+Uw3FrW4SAif+Qef8A66VpbcrL2z9m11ew4ilwnyAqXYfKavju7aAaUMxpLhi3Ay4Y5GgNDDLEMMw0WcmS3W15KjtY6CSkeYyagxtRdwheegiGng0DhrZ/XKAe/vBLqBwIeiJGEgIie+Dsm8xtRSaC3uwPMy3SEozXKbhsRB7r5GngpOOnUsjEMWm0HUk2ESkgFoJdG+GF/4B9a+Cax6DPkPbbOXM8rIqDkiR/0OItzeLkNM+SCp1UrIci04sNdA3uGWFOS8SO0jLJ5aqCyFemhyvpBlcvhEvbiZ+a0WIQrAXFQes8hzAtrqpCaTfzHLxpjDNX/G0KBnPtVUeCEYAbUKwW5CT4fCB8MPgqMNq4PfUy6NoDhk6AviM7b2r7R/DgZCgvg3iDuU/BTPmHXwPffwGIpm8Jc0FagglGJS9+FiNudO5bpYTLz3LSvSR/p9xiYToQgyLNtdZWRxWshfhGGHU3TPvPDAYJVPSCqx4A5wnLnw0duvQ0P9dug1LAnZuly5ZJ28JE45Kw1rlgBOR+8UqSPh10YmGkaYWsmvotfzKf+H4j0x5eC937w9S5yb8zDPj8dfjkPhh6IZRXZ95fNkhJMIrCcWV7n1swZ2KBSD4JAtN6dFSLVki4JAuCObAZ1j8C/qGw/VWo25qlOaYTVodJAxo3w+5XzXOYdJcZzxQCJwlGAt/WGRxulAgBLpdg4zaJ36Hz5ZlOIll8vUbvrgpnlGQ/YWyxHp24JDeppdXheti+Gj5aAIG/gmcYfLMc9mRhrI4qiO8HR08QRaDtMO+BAxg0A8beDL0nZKGjLHGSYHbUGgy8KwA749BNhaiEChWEwdJ349kJk4uBTzT+9TYPz/x7cRYaPJ7mgLYzl9SRhanbAStuBDUG4S8gGjAzoEt+A/2nmPUSq9Vgh4uTfq6pKKDH4PXpsP9tuGEvOBOFF6cHnAVmyE+6/cGwhIGCnUtKcEjQDFpOMhu2QDckxR7Bhq06y96USLJflGq2MJ1lSR3FMAJw6OAqhfJLoXIUDL0CSmvSH1e0EYRG6/VUQMZg8zI49DYMmgXFFeAoMJG05STBeJwCNMm+evBqkliWX9ojJYQ8kvqG3FUvU7EwSicWprw/fO/97I5r5UzY99rxF10tBaMRKrrBmNsKWyyQRDDdSgUcEihRiXB1XF5PF0XJzhxUezRXcdum1QfXQzwA1ReYfaebVmdCzSTo2j9RqItC4C+wfx2ccT5MWAIVZ+ZxMFa5aAqQRDDlRYJbJjpZsl7jFxe72HnUaFkFl08y0VNLUa6N9fjs53DoLbg+DsJhisYJJ/+yMoeMuvP47chRWDfDrLUUSum/M5I+YHMmuXnhpzF2S4NSN2g5OBkhO05JhUj8NiidtklYmDb7PF7wV7RuK8KMYYKbQYuk10+mFFVAz0kQ3wlaHoWbCUkFM6KHwv0PeTmnSwhPN0H3YgVdM98gJcnCnw6qV/Bik05D5GQ1huOSvccMKnzpKUZxmJVefXvrPocOzqOtrjC6yzzm4POw63GIB9PqKiMC2+DQG1DWF9yl+e8/HdpNkn98RRGNCyT9Rwf53YpiJvZWOBaQRKIZRsHSdBXjBysQ1Vm6Lsa9J7wa5LnP47xy0OD5NJeBusuh+jI48DQENoJ6BgQ2gdoTPjjfdEmh98DfB2QYvr4Hvn0UXCPouNqXLQQQheiXEDoMA+4C/7A89JsFhJTtVxNiEp5eE2POr5ugq+BH/+xgXJWCS2T2Th1z0TccCSpcPaWJO5d6mXaWC6cKr38R576Xwrx7fwkX1qRf9GnaBjsfhoZPzLkZxQEIkBogwdsHan4A3hrY+xQc/RPo+fz9tARXBfScBlXXgOrLY98Z0KFgmjnYaPD2lxrr9+kcCRpENZnx/JAE3A5BfZMkrEsqvAolRYLB3QQzxrjp37VQ5mdt2pKSYGxsmrEfYxtL2IKxsYQtGBtL2IKxsYQtGBtL2IKxsYQtGBtL/B/ZL6zg2EGF1QAAAABJRU5ErkJggg=="/>
    </div>
    <div>
      <div class="qs85-title" id="qs85_prev_title">Сводка по прошлому месяцу</div>
      <div class="qs85-cards">
        <div class="qs85-card">
          <div class="qs85-num ok" id="qs85_pay_ok">4</div>
          <div class="qs85-lbl" id="qs85_pay_ok_lbl">оплатили счета</div>
        </div>
        <div class="qs85-card">
          <div class="qs85-num bad" id="qs85_pay_bad">1</div>
          <div class="qs85-lbl" id="qs85_pay_bad_lbl">не оплатили счета</div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

              <div class="status-cards">
                <div class="stat">
                  <div class="num" id="stat_total">24</div>
                  <div class="lbl" id="lbl_total">квартир всего</div>
                </div>
                <div class="stat">
                  <div class="num" id="stat_done">20</div>
                  <div class="lbl" id="lbl_done">сдали показания</div>
                </div>
                <div class="stat" style="grid-column:1 / span 2">
                  <div class="num" id="stat_missing">4</div>
                  <div class="lbl" id="lbl_missing">не сдали</div>
                </div>
              </div>

              <div class="muted" style="margin-top:10px" id="quickNote">
                Дальше подключим реальные данные: статусы можно показывать жильцу только по его квартире.
              </div>
            </div>
          </div>
        </div>

        <!-- READINGS -->
        <div id="page_readings" class="hidden">
          <div class="page-title" id="readingsTitle">Показания</div>
          <div class="muted" id="readingsDesc" style="font-size:12px">Статус показаний по каждой квартире за прошлый месяц (пока демо).</div>

          <table style="margin-top:10px">
            <thead>
              <tr>
                <th id="thApartment">Квартира</th>
                <th id="thStatus">Статус</th>
                <th id="thComment">Комментарий</th>
              </tr>
            </thead>
            <tbody id="readingsBody"></tbody>
          </table>

          <div class="muted" style="font-size:12px; margin-top:8px">
            <span id="nextReadings1">Следующий шаг: читать данные из листа</span> <b>Reminder</b> <span id="nextReadings2">и фильтровать по квартире/роли.</span>
          </div>
        </div>

        <!-- BILLS -->
        <div id="page_bills" class="hidden">
          <div class="page-title" id="billsTitle">Счета</div>
          <div class="muted" id="billsDesc" style="font-size:12px">Выставленные счета за весь период (пока демо).</div>

          <table style="margin-top:10px">
            <thead>
              <tr>
                <th id="thPeriod">Период</th>
                <th id="thApartment2">Квартира</th>
                <th id="thSum">Сумма</th>
                <th id="thStatus2">Статус</th>
              </tr>
            </thead>
            <tbody id="billsBody"></tbody>
          </table>

          <div class="muted" style="font-size:12px; margin-top:8px">
            <span id="nextBills1">Следующий шаг: подключим лист</span> “Invoices” <span id="nextBills2">и покажем счета только по квартире жильца.</span>
          </div>
        </div>

      </section>
    </section>
  </main>

  <script>
    // API (Cloudflare Worker proxy)
    const API_BASE = "https://withered-lake-3ad8.andrei-voronenko836.workers.dev";

    
    // Helpers
    function byId(id){ return document.getElementById(id); }
// i18n packs (full coverage for UI + demo strings)
    const I18N = {
      ru: {
        portal_title: "Karusselli 4 KÜ портал",
        brandTitle: "Karusselli 4 KÜ",
        brandSub: "",
        statusOut: "Вход не выполнен",
        statusIn: (u)=> `Вход выполнен: ${u}`,
        logout: "Выйти",

        loginTitle: "Войти",
        loginSub: "Введите имя пользователя и пароль.",
        userLabel: "Имя пользователя",
        passLabel: "Пароль",
        loginBtn: "Войти",
        forgot: "Забыли пароль?",

        regTitle: "Создать аккаунт",
        regSub: "Создайте имя пользователя и пароль.",
        aptLabel: "Квартира",
        regBtn: "Создать аккаунт",

        ph_user: "например: member12",
        ph_reg_user: "например: test1",
        ph_pass_login: "••••••••",
        ph_pass_reg: "минимум 6 символов",
        ph_apt: "например: 5",

        regOk: "Регистрация успешна. Теперь можно войти.",
        errReg: "Ошибка регистрации",
        errLogin: "Ошибка входа",

        tabHome: "Главная",
        tabReadings: "Показания",
        tabBills: "Счета",

        contactTitle: "Контактная информация",
        boardMembersTitle: "Члены правления",
        chairmanTitle: "Председатель",
        boardMemberTitle: "Член правления",
        phName: "[имя фамилия]",
        phEmailPhone: "[email]/телефон",
        addressTitle: "Адрес",
        bankDetailsTitle: "Банковские реквизиты",
        bankTitle: "Банк",
        recipientTitle: "Получатель",
        phIban: "[EE.. ..]",
        phBank: "[Swedbank / SEB / ..]",

        quickTitle: "Быстрый статус",
        quickSub: "Сводка по прошлому месяцу (демо-данные):",
        lblTotal: "квартир всего",
        lblDone: "сдали показания",
        lblMissing: "не сдали",
        quickNote: "Дальше подключим реальные данные: статусы можно показывать жильцу только по его квартире.",

        readingsDesc: "Статус показаний по каждой квартире за прошлый месяц (пока демо).",
        billsDesc: "Выставленные счета за весь период (пока демо).",
        thApartment: "Квартира",
        thStatus: "Статус",
        thComment: "Комментарий",
        thPeriod: "Период",
        thSum: "Сумма",

        nextReadings1: "Следующий шаг: читать данные из листа",
        nextReadings2: "и фильтровать по квартире/роли.",
        nextBills1: "Следующий шаг: подключим лист",
        nextBills2: "и покажем счета только по квартире жильца.",

        stSubmitted: "✅ Сдано",
        stWaiting: "⏳ Ожидается",
        commentDash: "—",
        commentReminder: "Напоминание: последний день месяца",
        billPaid: "Оплачено",
        billPending: "Ожидает оплаты",
        forgotPrompt: "Введите email или имя пользователя:",
        forgotSent: "Мы отправили код для сброса на ваш email. Проверьте входящие/спам.",
        resetCodePrompt: "Введите код из письма:",
        resetNewPassPrompt: "Введите НОВЫЙ пароль (мин 6):",
        resetDone: "Пароль обновлён. Теперь можно войти.",
        resetCodeSent: "Код отправлен. Введите его ниже.",
        forgotError: "Ошибка сброса пароля: ",
        missing_code: "Введите код из письма.",
        network_error: "Ошибка сети. Попробуйте ещё раз.",
        user_not_found: "Пользователь не найден.",
    reset_title: "Сброс пароля",
    reset_desc: "Введите имя пользователя или email, указанный при регистрации. Мы отправим код сброса.",
    username_or_email: "Имя пользователя или email",
    send_code: "Отправить код",
    new_password: "Новый пароль",
    continue: "Продолжить",
    close: "Закрыть",
    code_sent: "Код отправлен",
    sending: "Отправка…",
    verifying: "Проверка…",
    password_reset_ok: "Пароль изменён",
    missing_identifier: "Введите имя пользователя или email",
    missing_new_password: "Введите новый пароль",
    password_too_short: "Пароль слишком короткий (мин. 6 символов)",
    invalid_code: "Неверный или просроченный код",
    reset_done_close: "Готово",
},

      et: {

        forgot: "Unustasid parooli?",
        brandTitle: "Karusselli 4 KÜ",
        brandSub: "",
        statusOut: "Pole sisse logitud",
        statusIn: (u)=> `Sisselogitud: ${u}`,
        logout: "Logi välja",

        loginTitle: "Logi sisse",
        loginSub: "Sisesta kasutajanimi ja parool.",
        userLabel: "Kasutajanimi",
        passLabel: "Parool",
        loginBtn: "Logi sisse",

        regTitle: "Loo konto",
        regSub: "Loo kasutajanimi ja parool.",
        aptLabel: "Korter",
        regBtn: "Loo konto",

        ph_user: "nt: member12",
        ph_reg_user: "nt: test1",
        ph_pass_login: "••••••••",
        ph_pass_reg: "vähemalt 6 märki",
        ph_apt: "nt: 5",

        regOk: "Registreerimine õnnestus. Nüüd saad sisse logida.",
        errReg: "Registreerimise viga",
        errLogin: "Sisselogimise viga",

        tabHome: "Avaleht",
        tabReadings: "Näidud",
        tabBills: "Arved",

        contactTitle: "Kontaktinfo",
        boardMembersTitle: "Juhatuse liikmed",
        chairmanTitle: "Esimees",
        boardMemberTitle: "Juhatuse liige",
        phName: "[ees- ja perekonnanimi]",
        phEmailPhone: "[e-post]/telefon",
        addressTitle: "Aadress",
        bankDetailsTitle: "Pangaandmed",
        bankTitle: "Pank",
        recipientTitle: "Saaja",
        phIban: "[EE.. ..]",
        phBank: "[Swedbank / SEB / ..]",

        quickTitle: "Kiire ülevaade",
        quickSub: "Eelmise kuu kokkuvõte (demo):",
        lblTotal: "kortereid kokku",
        lblDone: "esitasid näidud",
        lblMissing: "ei esitanud",
        quickNote: "Järgmisena ühendame pärisandmed: elanik näeb staatust ainult oma korteri kohta.",

        readingsDesc: "Näitude staatus iga korteri kohta eelmise kuu eest (demo).",
        billsDesc: "Esitatud arved kogu perioodi kohta (demo).",
        thApartment: "Korter",
        thStatus: "Staatus",
        thComment: "Kommentaar",
        thPeriod: "Periood",
        thSum: "Summa",

        nextReadings1: "Järgmine samm: loeme andmed lehelt",
        nextReadings2: "ja filtreerime korteri/rolli järgi.",
        nextBills1: "Järgmine samm: ühendame lehe",
        nextBills2: "ja näitame arveid ainult elaniku korteri kohta.",

        stSubmitted: "✅ Esitatud",
        stWaiting: "⏳ Ootel",
        commentDash: "—",
        commentReminder: "Meeldetuletus: kuu viimane päev",
        billPaid: "Makstud",
        billPending: "Ootab makset",
        forgotPrompt: "Sisesta email või kasutajanimi:",
        forgotSent: "Saatsime parooli lähtestamise koodi sinu e-postile. Kontrolli ka spam-kausta.",
        resetCodePrompt: "Sisesta e-kirjas olev kood:",
        resetNewPassPrompt: "Sisesta UUS parool (min 6):",
        resetDone: "Parool uuendatud. Nüüd saad sisse logida.",
        resetCodeSent: "Kood saadetud. Sisestage see allpool.",
        forgotError: "Parooli lähtestamise viga: ",
        missing_code: "Sisesta e-kirjas saadud kood.",
        network_error: "Võrgu viga. Proovi uuesti.",
        user_not_found: "Kasutajat ei leitud.",
    reset_title: "Parooli taastamine",
    reset_desc: "Sisesta registreerimisel kasutatud kasutajanimi või e‑post. Saadame taastamiskoodi.",
    username_or_email: "Kasutajanimi või e‑post",
    send_code: "Saada kood",
    new_password: "Uus parool",
    continue: "Jätka",
    close: "Sulge",
    code_sent: "Kood saadetud",
    sending: "Saatmine…",
    verifying: "Kontrollimine…",
    password_reset_ok: "Parool muudetud",
    missing_identifier: "Sisesta kasutajanimi või e‑post",
    missing_new_password: "Sisesta uus parool",
    password_too_short: "Parool liiga lühike (min 6 märki)",
    invalid_code: "Vale või aegunud kood",
    reset_done_close: "Valmis",
},

      en: {
        portal_title: "Karusselli 4 KÜ portal",
        brandTitle: "Karusselli 4 KÜ",
        brandSub: "",
        statusOut: "Not logged in",
        statusIn: (u)=> `Logged in: ${u}`,
        logout: "Log out",

        loginTitle: "Sign in",
        loginSub: "Enter your username and password.",
        userLabel: "Username",
        passLabel: "Password",
        loginBtn: "Sign in",
        forgot: "Forgot password?",

        regTitle: "Create account",
        regSub: "Create a username and password.",
        aptLabel: "Apartment",
        regBtn: "Create account",

        ph_user: "e.g.: member12",
        ph_reg_user: "e.g.: test1",
        ph_pass_login: "••••••••",
        ph_pass_reg: "min 6 characters",
        ph_apt: "e.g.: 5",

        regOk: "Registration successful. You can now sign in.",
        errReg: "Registration error",
        errLogin: "Sign-in error",

        tabHome: "Home",
        tabReadings: "Readings",
        tabBills: "Invoices",

        contactTitle: "Contact info",
        boardMembersTitle: "Board members",
        chairmanTitle: "Chairman",
        boardMemberTitle: "Board member",
        phName: "[name surname]",
        phEmailPhone: "[email]/phone",
        addressTitle: "Address",
        bankDetailsTitle: "Bank details",
        bankTitle: "Bank",
        recipientTitle: "Recipient",
        phIban: "[EE.. ..]",
        phBank: "[Swedbank / SEB / ..]",

        quickTitle: "Quick status",
        quickSub: "Summary for last month (demo data):",
        lblTotal: "apartments total",
        lblDone: "submitted readings",
        lblMissing: "missing",
        quickNote: "Next we’ll connect real data: residents should see status only for their apartment.",

        readingsDesc: "Reading status per apartment for last month (demo).",
        billsDesc: "Issued invoices for the whole period (demo).",
        thApartment: "Apartment",
        thStatus: "Status",
        thComment: "Comment",
        thPeriod: "Period",
        thSum: "Amount",

        nextReadings1: "Next step: read data from sheet",
        nextReadings2: "and filter by apartment/role.",
        nextBills1: "Next step: connect sheet",
        nextBills2: "and show invoices only for resident’s apartment.",

        stSubmitted: "✅ Submitted",
        stWaiting: "⏳ Pending",
        commentDash: "—",
        commentReminder: "Reminder: last day of month",
        billPaid: "Paid",
        billPending: "Payment pending",
        forgotPrompt: "Enter email or username:",
        forgotSent: "We sent a reset code to your email. Check inbox/spam.",
        resetCodePrompt: "Enter the code from the email:",
        resetNewPassPrompt: "Enter a NEW password (min 6):",
        resetDone: "Password updated. You can sign in now.",
        resetCodeSent: "Code sent. Enter it below.",
        forgotError: "Password reset error: ",
        missing_code: "Enter the code from the email.",
        network_error: "Network error. Please try again.",
        user_not_found: "User not found.",
    reset_title: "Password reset",
    reset_desc: "Enter the username or email used during registration. We will send a reset code.",
    username_or_email: "Username or email",
    send_code: "Send code",
    new_password: "New password",
    continue: "Continue",
    close: "Close",
    code_sent: "Code sent",
    sending: "Sending…",
    verifying: "Verifying…",
    password_reset_ok: "Password changed",
    missing_identifier: "Enter username or email",
    missing_new_password: "Enter new password",
    password_too_short: "Password too short (min 6 characters)",
    invalid_code: "Invalid or expired code",
    reset_done_close: "Done",
}
    };

    function getLang(){
      const saved = localStorage.getItem("ku_lang");
      if (saved && I18N[saved]) return saved;
      return "ru";
    }

function getLangSafe(){
  try { return getLang(); } catch(e){ return 'ru'; }
}

    function setLang(lang){
      if (!I18N[lang]) return;
      localStorage.setItem("ku_lang", lang);
      applyLang();
      // if logged in — refresh table texts in current language
      const saved = localStorage.getItem("ku_user");
      if (saved){
        try { renderDemoTables(JSON.parse(saved)); } catch(_){}
      }
    }
    const TEXT = (typeof I18N !== "undefined" ? I18N : {});

    function tr(key){
      const lang = getLang();
      const pack = (TEXT[lang] || TEXT.ru || {});
      if (pack && Object.prototype.hasOwnProperty.call(pack, key)) return pack[key];
      const fallback = (TEXT.ru || {});
      if (fallback && Object.prototype.hasOwnProperty.call(fallback, key)) return fallback[key];
      return key;
    }
    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function setStatus(isIn, username){
      const dot = document.getElementById("statusDot");
      const text = document.getElementById("statusText");
      const pack = I18N[getLang()] || I18N.ru;

      dot.classList.toggle("good", !!isIn);
      dot.classList.toggle("bad", !isIn);

      text.textContent = isIn ? pack.statusIn(username || "") : pack.statusOut;
      document.getElementById("btnTopLogout").style.display = isIn ? "inline-block" : "none";
    }

    function applyLang(){
      const lang = getLang();
      const t = I18N[lang] || I18N.ru;

      document.documentElement.lang = (lang === "et" ? "et" : lang);

      // top
      document.getElementById("brandTitle").textContent = t.brandTitle;
      document.getElementById("brandSub").textContent = t.brandSub;
      document.getElementById("btnTopLogout").textContent = t.logout;

      // auth texts
      document.getElementById("loginTitle").textContent = t.loginTitle;
      document.getElementById("loginSub").textContent = t.loginSub;
      document.getElementById("loginUserLabel").textContent = t.userLabel;
      document.getElementById("loginPassLabel").textContent = t.passLabel;
      document.getElementById("btnLogin").textContent = t.loginBtn;

      document.getElementById("registerTitle").textContent = t.regTitle;
      document.getElementById("registerSub").textContent = t.regSub;
      document.getElementById("regUserLabel").textContent = t.userLabel;
      document.getElementById("regPassLabel").textContent = t.passLabel;
      document.getElementById("aptLabel").textContent = t.aptLabel;
      document.getElementById("btnRegister").textContent = t.regBtn;

      document.getElementById("log_user").placeholder = t.ph_user;
      document.getElementById("reg_user").placeholder = t.ph_reg_user;
      document.getElementById("log_pass").placeholder = t.ph_pass_login;
      document.getElementById("reg_pass").placeholder = t.ph_pass_reg;
      document.getElementById("reg_apt").placeholder = t.ph_apt;

      // app nav
      document.getElementById("tab_home").textContent = t.tabHome;
      document.getElementById("tab_readings").textContent = t.tabReadings;
      document.getElementById("tab_bills").textContent = t.tabBills;

      // page titles + blocks
      document.getElementById("homeTitle").textContent = t.tabHome;
      document.getElementById("readingsTitle").textContent = t.tabReadings;
      document.getElementById("billsTitle").textContent = t.tabBills;

      document.getElementById("contactTitle").textContent = t.contactTitle;
      document.getElementById("boardMembersTitle").textContent = t.boardMembersTitle;
      document.getElementById("chairmanTitle").textContent = t.chairmanTitle;
      document.getElementById("boardMemberTitle").textContent = t.boardMemberTitle;

      document.getElementById("phName1").textContent = t.phName;
      document.getElementById("phName2").textContent = t.phName;
      document.getElementById("phEmailPhone1").textContent = t.phEmailPhone;
      document.getElementById("phEmailPhone2").textContent = t.phEmailPhone;

      document.getElementById("addressTitle").textContent = t.addressTitle;
      document.getElementById("bankDetailsTitle").textContent = t.bankDetailsTitle;
      document.getElementById("bankTitle").textContent = t.bankTitle;
      document.getElementById("recipientTitle").textContent = t.recipientTitle;
      document.getElementById("phIban").textContent = t.phIban;
      document.getElementById("phBank").textContent = t.phBank;

      document.getElementById("quickTitle").textContent = t.quickTitle;
      document.getElementById("quickSub").textContent = t.quickSub;
      document.getElementById("lbl_total").textContent = t.lblTotal;
      document.getElementById("lbl_done").textContent = t.lblDone;
      document.getElementById("lbl_missing").textContent = t.lblMissing;
      document.getElementById("quickNote").textContent = t.quickNote;

      document.getElementById("readingsDesc").textContent = t.readingsDesc;
      document.getElementById("billsDesc").textContent = t.billsDesc;

      document.getElementById("thApartment").textContent = t.thApartment;
      document.getElementById("thApartment2").textContent = t.thApartment;
      document.getElementById("thStatus").textContent = t.thStatus;
      document.getElementById("thStatus2").textContent = t.thStatus;
      document.getElementById("thComment").textContent = t.thComment;
      document.getElementById("thPeriod").textContent = t.thPeriod;
      document.getElementById("thSum").textContent = t.thSum;

      document.getElementById("nextReadings1").textContent = t.nextReadings1;
      document.getElementById("nextReadings2").textContent = t.nextReadings2;
      document.getElementById("nextBills1").textContent = t.nextBills1;
      document.getElementById("nextBills2").textContent = t.nextBills2;
      // status (header only)
const saved = localStorage.getItem("ku_user");
if (saved){
  try{
    const u = JSON.parse(saved);
    setStatus(true, u.username);
  }catch(_){
    setStatus(false);
  }
}else{
  setStatus(false);
}

// Apply generic i18n bindings (e.g. reset modal)
document.querySelectorAll("[data-i18n]").forEach(el => {
  const k = el.getAttribute("data-i18n");
  if (!k) return;
  el.textContent = tr(k);
});
document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
  const k = el.getAttribute("data-i18n-placeholder");
  if (!k) return;
  el.setAttribute("placeholder", tr(k));
});

// active lang button

      const bRu=document.getElementById("lang_ru"); if(bRu) bRu.classList.toggle("active", lang==="ru");
      const bEt=document.getElementById("lang_et"); if(bEt) bEt.classList.toggle("active", lang==="et");
      const bEn=document.getElementById("lang_en"); if(bEn) bEn.classList.toggle("active", lang==="en");
      const sel=document.getElementById("langSelect"); if(sel) sel.value = lang;
      }

    
    function mountControls(toApp){
      const top = document.getElementById("topRightActions");
      const app = document.getElementById("appRightControls");
      if (!top || !app) return;

      const nodes = ["langSelect","statusPill","btnTopLogout"].map(id=>document.getElementById(id)).filter(Boolean);

      // place controls depending on current view
      const target = toApp ? app : top;
      nodes.forEach(n=>{ if (n.parentElement !== target) target.appendChild(n); });
    }
    function isAppVisible(){
      const app = document.getElementById("appSection");
      return app && !app.classList.contains("hidden");
    }

    function showAuth(){
      document.getElementById("authSection").classList.remove("hidden");
      document.getElementById("appSection").classList.add("hidden");
      setStatus(false);
      mountControls(false);
      applyLang();
    }

    function showApp(user){
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("appSection").classList.remove("hidden");
      mountControls(true);

      const t = I18N[getLang()] || I18N.ru;

      setStatus(true, user.username);

      renderDemoTables(user);
      navigate("home");
    }

    function markActive(page){
      document.querySelectorAll("[data-page]").forEach(el=>{
        el.classList.toggle("active", el.getAttribute("data-page") === page);
      });
      ["home","readings","bills"].forEach(p=>{
        document.getElementById("page_"+p).classList.toggle("hidden", p !== page);
      });
    }

    function navigate(page){
      markActive(page);
      history.replaceState(null,"", "#"+page);
    }

    function renderDemoTables(user){
      const t = I18N[getLang()] || I18N.ru;
      const role = user.role || "member";
      const apt = String(user.apartment || "");
      const apartments = (role === "board") ? Array.from({length:24}, (_,i)=>String(i+1)) : [apt];

      // readings demo
      const rb = document.getElementById("readingsBody");
      rb.innerHTML = "";
      apartments.slice(0, role==="board" ? 10 : 1).forEach((a,i)=>{
        const ok = (i % 3 !== 0);
        rb.insertAdjacentHTML("beforeend", `
          <tr>
            <td><b>${esc(a)}</b></td>
            <td class="${ok ? "ok":"warn"}">${ok ? esc(t.stSubmitted) : esc(t.stWaiting)}</td>
            <td>${ok ? esc(t.commentDash) : esc(t.commentReminder)}</td>
          </tr>
        `);
      });

      // bills demo
      const bb = document.getElementById("billsBody");
      bb.innerHTML = "";
      const demo = [
        {period:"2025-11", apt:apt || "—", sum:"123.45 €", st: t.billPaid, ok:true},
        {period:"2025-12", apt:apt || "—", sum:"98.10 €", st: t.billPending, ok:false},
      ];
      demo.forEach(x=>{
        bb.insertAdjacentHTML("beforeend", `
          <tr>
            <td><b>${esc(x.period)}</b></td>
            <td>${esc(x.apt)}</td>
            <td>${esc(x.sum)}</td>
            <td class="${x.ok ? "ok":"warn"}">${esc(x.st)}</td>
          </tr>
        `);
      });
    }

    async function apiPost(path, payload){
      // Robust fetch with timeout to avoid hanging UI when Apps Script is slow/unreachable
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 20000); // 20s
      try{
        const res = await fetch(API_BASE + path, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload || {}),
          signal: ctrl.signal
        });
        const data = await res.json().catch(()=>({ ok:false, error:"Bad JSON" }));
        // If upstream returns non-2xx, still surface the payload error if present
        if (!res.ok && data && typeof data === "object" && !data.ok){
          data.http_status = res.status;
        }
        return data;
      }catch(err){
        const msg = (err && err.name === "AbortError") ? "Request timeout" : String(err);
        return { ok:false, error: msg };
      }finally{
        clearTimeout(t);
      }
    }

    // Compatibility alias used by forgot/reset helpers
    async function apiCall(path, payload){
      return apiPost(path, payload);
    }

    async function register(){
      const u = document.getElementById("reg_user").value.trim();
      const p = document.getElementById("reg_pass").value;
      const a = document.getElementById("reg_apt").value.trim();
      const e = document.getElementById("reg_email").value.trim();
      const msg = document.getElementById("reg_msg");
      msg.className="msg"; msg.textContent="";

      const d = await apiPost("/register", {username:u,password:p,apartment:a,email:e});
      const t = I18N[getLang()] || I18N.ru;

      if(d.ok){
        msg.className="msg ok";
        msg.textContent = t.regOk;
      }else{
        msg.className="msg err";
        msg.textContent = d.error || t.errReg;
      }
    }

    async function login(){
      const u = document.getElementById("log_user").value.trim();
      const p = document.getElementById("log_pass").value;
      const msg = document.getElementById("log_msg");
      msg.className="msg"; msg.textContent="";

      const d = await apiPost("/login", {username:u,password:p});
      const t = I18N[getLang()] || I18N.ru;

      if(!d.ok){
        msg.className="msg err";
        msg.textContent = d.error || t.errLogin;
        return;
      }

      const user = { username:u, apartment:d.apartment, role:d.role || "member" };
      localStorage.setItem("ku_user", JSON.stringify(user));
      localStorage.setItem("ku_token", d.token || "");
      showApp(user);
    }

    function logout(){
      localStorage.removeItem("ku_user");
      localStorage.removeItem("ku_token");
      showAuth();
    }

    // wire
    document.getElementById("btnRegister").addEventListener("click", register);
    document.getElementById("btnLogin").addEventListener("click", login);
    document.getElementById("btnTopLogout").addEventListener("click", logout);

    // tabs
    document.querySelectorAll(".tab").forEach(b=>{
      b.addEventListener("click", ()=> navigate(b.getAttribute("data-page")));
    });

    // language switch
    const _lru=document.getElementById("lang_ru"); if(_lru) _lru.addEventListener("click", ()=> setLang("ru"));
    const _let=document.getElementById("lang_et"); if(_let) _let.addEventListener("click", ()=> setLang("et"));
    const _len=document.getElementById("lang_en"); if(_len) _len.addEventListener("click", ()=> setLang("en"));
    const langSelect=document.getElementById("langSelect");
    if(langSelect){
      langSelect.addEventListener("change", ()=> setLang(langSelect.value));
      langSelect.value = getLang();
    }

    // restore
    (function init(){
      applyLang();
      const saved = localStorage.getItem("ku_user");
      if(!saved){ showAuth(); return; }
      try{
        const user = JSON.parse(saved);
        if(user && user.username){ showApp(user); }
        else showAuth();
      }catch(_){
        showAuth();
      }
    })();
  
    // --- Forgot password (email reset) ---
// In-page modal (not browser prompt) so it won't disappear when switching windows.
// IMPORTANT: modal markup is placed AFTER this <script>, so DO NOT cache elements at load time.

const resetFlow = { stage: 1, identifier: "" }; // 1: ask identifier, 2: ask code

function getLang_() {
  return (window.lang || localStorage.getItem("lang") || "RU").toUpperCase();
}
function t_(key, fallback) {
  const L = getLang_();
  return (window.TEXT && window.TEXT[L] && window.TEXT[L][key]) || fallback || key;
}

function showReset_() {
  const m = byId("resetModal");
  if (!m) return;

  // reset state
  window.__resetIdentifier = "";
  const msg1 = byId("resetMsg");
  const msg2 = byId("resetMsg2");
  if (msg1) msg1.textContent = "";
  if (msg2) msg2.textContent = "";

  const step2 = byId("resetStep2");
  if (step2) step2.style.display = "none";

  const email = byId("resetEmail");
  const codeEl = byId("resetCode");
  const passEl = byId("resetNewPass");
  if (email) {
    email.type = "text";
    email.value = "";
  }
  if (codeEl) codeEl.value = "";
  if (passEl) passEl.value = "";

  const sendBtn = byId("resetSendBtn");
  const doBtn = byId("resetDoBtn");
  if (sendBtn) sendBtn.disabled = false;
  if (doBtn) doBtn.disabled = false;

  // Apply i18n to modal elements explicitly
  const titleEl = byId("resetTitle");
  const hintEl = byId("resetHint");
  const idLabel = byId("resetIdentifierLabel");
  const codeLabel = byId("resetCodeLabel");
  const newPassLabel = byId("resetNewPassLabel");

  if (titleEl) titleEl.textContent = tr("reset_title");
  if (hintEl) hintEl.textContent = tr("reset_desc");
  if (idLabel) idLabel.textContent = tr("username_or_email");
  if (codeLabel) codeLabel.textContent = tr("code");
  if (newPassLabel) newPassLabel.textContent = tr("new_password");
  if (sendBtn) sendBtn.textContent = tr("send_code");
  if (doBtn) doBtn.textContent = tr("continue");

  m.style.display = "block";
}


function hideReset_() {
  const m = byId("resetModal");
  if (!m) return;
  m.style.display = "none";
}

async function onSendCode_() {
  const idEl = byId("resetEmail");
  const msg1 = byId("resetMsg");
  const msg2 = byId("resetMsg2");
  const step2 = byId("resetStep2");
  const sendBtn = byId("resetSendBtn");

  const identifier = String(idEl && idEl.value ? idEl.value : "").trim();
  if (!identifier) {
    if (msg2) msg2.textContent = tr("missing_identifier");
    return;
  }

  // reset UI state
  if (msg1) msg1.textContent = tr("sending");
  if (msg2) msg2.textContent = "";
  if (step2) step2.style.display = "none";
  window.__resetIdentifier = ""; // will be set only on success

  if (sendBtn) sendBtn.disabled = true;

  try {
    const res = await apiCall("/forgot", { identifier, lang: getLang() });

    if (!res || res.ok !== true) {
      const err = (res && res.error) ? String(res.error) : "error";
      // show errors in the PRIMARY status area so it is always visible
      if (msg1) { msg1.style.color = "#b00020"; msg1.textContent = tr(err); }
      if (msg2) msg2.textContent = "";
      return;
    }

    // success: code sent
    window.__resetIdentifier = identifier;
    if (msg1) { msg1.style.color = ""; msg1.textContent = tr("code_sent"); }
    if (msg2) msg2.textContent = "";
    if (step2) step2.style.display = "block";

    const codeEl = byId("resetCode");
    if (codeEl) codeEl.focus();
  } catch (e) {
    if (msg1) msg1.textContent = "";
    if (msg2) msg2.textContent = tr("network_error");
  } finally {
    if (sendBtn) sendBtn.disabled = false;
  }
}


async function onVerifyCode_() {
  const idEl = byId("resetEmail");
  const codeEl = byId("resetCode");
  const passEl = byId("resetNewPass");
  const msg2 = byId("resetMsg2");
  const doBtn = byId("resetDoBtn");

  const identifier = (window.__resetIdentifier || (idEl && idEl.value) || "").toString().trim();
  const code = (codeEl && codeEl.value ? codeEl.value : "").toString().trim();
  const new_password = (passEl && passEl.value ? passEl.value : "").toString();

  if (!identifier) {
    if (msg2) msg2.textContent = tr("missing_identifier");
    return;
  }
  if (!code) {
    if (msg2) msg2.textContent = tr("missing_code");
    return;
  }
  if (!new_password || new_password.length < 6) {
    if (msg2) msg2.textContent = tr("password_too_short");
    return;
  }

  if (doBtn) doBtn.disabled = true;
  if (msg2) msg2.textContent = tr("verifying");

  try {
    const res = await apiCall("/reset", { identifier, code, new_password, lang: getLang() });

    if (!res || res.ok !== true) {
      const err = (res && res.error) ? String(res.error) : "error";
      if (msg2) { msg2.style.color = "#b00020"; msg2.textContent = tr(err); }
      return;
    }

    if (msg2) msg2.textContent = tr("password_reset_ok");

    // Close modal and clear state
    window.__resetIdentifier = "";
    setTimeout(() => {
      hideReset_();
      // Optional: prefill login username
      const loginUser = byId("loginUsername");
      if (loginUser && !loginUser.value) loginUser.value = identifier;

    }, 400);
  } catch (e) {
    if (msg2) msg2.textContent = tr("network_error");
  } finally {
    if (doBtn) doBtn.disabled = false;
  }
}


// Delegate clicks so language re-render won't break handlers
document.addEventListener("click", (e) => {
  const forgot = e.target && e.target.closest ? e.target.closest("#forgotLink") : null;
  if (forgot) { e.preventDefault(); showReset_(); return; }

  if (e.target && e.target.id === "resetSendBtn") { e.preventDefault(); onSendCode_(); return; }
  if (e.target && e.target.id === "resetDoBtn") { e.preventDefault(); onVerifyCode_(); return; }
  if (e.target && (e.target.id === "resetClose" || e.target.id === "resetX")) { e.preventDefault(); hideReset_(); return; }

  // Close only when clicking on overlay background (not when switching windows)
  if (e.target && e.target.id === "resetModal") { hideReset_(); return; }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    const m = byId("resetModal");
    if (m && m.style.display === "block") hideReset_();
  }
});

</script>

  <div id="resetModal" class="modal" style="display:none">
    <div class="modal-backdrop" id="resetClose"></div>
    <div class="modal-card">
      <div class="modal-head">
        <div class="h2" data-i18n="reset_title">Password reset</div>
        <button class="iconbtn" id="resetX" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <p class="muted" data-i18n="reset_desc">Enter the email used during registration. We will send a reset code.</p>

        <div class="field">
          <label><span data-i18n="username_or_email">Username or email</span></label>
          <input id="resetEmail" type="text" autocomplete="email" placeholder="name@example.com"/>
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-top:10px">
          <button class="btn primary" id="resetSendBtn" data-i18n="send_code">Send</button>
          <div class="muted" id="resetMsg" style="flex:1"></div>
        </div>

        <div id="resetStep2" style="display:none; margin-top:14px">
          <div class="grid2">
            <div class="field">
              <label><span data-i18n="code">Code</span></label>
              <input id="resetCode" type="text" inputmode="numeric" autocomplete="one-time-code" placeholder="123456"/>
            </div>
            <div class="field">
              <label><span data-i18n="new_password">New password</span></label>
              <input id="resetNewPass" type="password" autocomplete="new-password" placeholder="••••••••"/>
            </div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; margin-top:10px">
            <button class="btn primary" id="resetDoBtn" data-i18n="continue">Reset password</button>
            <div class="muted" id="resetMsg2" style="flex:1"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>
</html>